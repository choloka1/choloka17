<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>რენტაბელობის მანქანა | Agro Imperial</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Fira+GO:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --imperial-green: #042f24;
            --royal-gold: #d4af37;
            --soft-bg: #f4f7f6;
            --white: #ffffff;
            --profit-green: #27ae60;
            --expense-red: #e74c3c;
            --revenue-blue: #007bff;
        }

        body { background-color: var(--soft-bg); font-family: 'Montserrat', 'Fira GO', sans-serif; color: var(--imperial-green); margin: 0; }
        .analytics-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }

        .calculator-card { background: var(--white); border-radius: 35px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.06); padding: 45px; position: relative; }
        .gold-line { width: 70px; height: 5px; background: var(--royal-gold); margin: 12px auto; border-radius: 50px; }

        /* --- New Imperial Metrics Bar (image_f17996.png style) --- */
        .metrics-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #fff;
            padding: 40px 20px;
            border-radius: 25px;
            border: 1px solid rgba(0,0,0,0.05);
            margin-bottom: 40px;
            text-align: center;
        }
        .metric-item { flex: 1; border-right: 1px solid #eee; }
        .metric-item:last-child { border-right: none; }
        .m-label { color: var(--royal-gold); font-size: 0.8rem; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }
        .m-value { font-size: 2.2rem; font-weight: 800; letter-spacing: -1px; }

        /* --- ROI Highlight (Rentability) --- */
        .roi-shield {
            background: linear-gradient(135deg, var(--imperial-green), #064d3c);
            color: white;
            border-radius: 30px;
            padding: 35px;
            text-align: center;
            margin-bottom: 40px;
            border: 2px solid var(--royal-gold);
            box-shadow: 0 20px 40px rgba(4, 47, 36, 0.2);
        }

        /* --- Table Styling --- */
        .imperial-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .imperial-table th { background: var(--imperial-green); color: var(--royal-gold); padding: 15px; font-size: 0.7rem; text-transform: uppercase; border: none; }
        .imperial-table td { background: #fbfbfb; padding: 15px; font-weight: 600; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        .imperial-table tr td:first-child { border-left: 1px solid #eee; border-radius: 12px 0 0 12px; }
        .imperial-table tr td:last-child { border-right: 1px solid #eee; border-radius: 0 12px 12px 0; }

        .btn-calculate { background: var(--imperial-green); color: white; border: none; border-radius: 15px; padding: 18px; font-weight: 800; transition: 0.4s; }
        .btn-calculate:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(4, 47, 36, 0.2); color: white; }
    </style>
</head>
<body>

{% include 'base.html' %}

<div class="analytics-container">
    <div class="calculator-card">
        <div class="header-section text-center mb-5">
            <h2 class="fw-800">რენტაბელობის <span>მანქანა</span></h2>
            <div class="gold-line"></div>
        </div>

        <form method="POST" class="mb-5">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase">სიგრძე (მ)</label>
                    <input type="number" step="0.01" name="length" class="form-control" placeholder="მაგ: 120">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase">სიგანე (მ)</label>
                    <input type="number" step="0.01" name="width" class="form-control" placeholder="მაგ: 80">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase">ფართობი (მ²)</label>
                    <input type="number" step="0.01" name="area" class="form-control" placeholder="ჯამური ფართობი">
                </div>
                <div class="col-md-12">
                    <label class="form-label fw-bold small text-uppercase">აირჩიე კულტურა</label>
                    <select class="form-select" name="crop" required>
                        <option disabled selected>აირჩიეთ...</option>
                        {% if crops %}
                            {% for crop_name in crops.keys() %}
                                <option value="{{ crop_name }}">{{ crop_name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
            <button type="submit" class="btn-calculate w-100 mt-4">ანალიზის დაწყება</button>
        </form>

        {% if result %}
        <div class="result-box border-top pt-5">

            <div class="roi-shield">
                <h6 class="text-uppercase fw-bold opacity-75 mb-2" style="letter-spacing: 3px;">პროექტის რენტაბელობა (ROI)</h6>
                <div class="d-flex align-items-center justify-content-center gap-4">
                    <div style="font-size: 4.5rem; font-weight: 900; line-height: 1;">
                        {{ ((result.profit / result.costs) * 100) | round(1) if result.costs > 0 else 0 }}%
                    </div>
                    <div class="text-start">
                        <div class="fw-bold fs-5 text-warning">ეფექტური ინვესტიცია</div>
                        <div class="small opacity-75">მოგება ყოველ მ²-ზე: {{ (result.profit / result.area) | round(2) }} ₾</div>
                    </div>
                </div>
            </div>

            <div class="metrics-bar">
                <div class="metric-item">
                    <div class="m-label">ჯამური მოსავალი</div>
                    <div class="m-value" style="color: #042f24;">{{ result.yield }} <span class="fs-4">კგ</span></div>
                </div>
                <div class="metric-item">
                    <div class="m-label">მთლიანი შემოსავალი</div>
                    <div class="m-value" style="color: #007bff;">{{ result.income }} <span class="fs-4">₾</span></div>
                </div>
                <div class="metric-item">
                    <div class="m-label">ჯამური ხარჯი</div>
                    <div class="m-value" style="color: #e74c3c;">{{ result.costs }} <span class="fs-4">₾</span></div>
                </div>
                <div class="metric-item">
                    <div class="m-label">წმინდა მოგება</div>
                    <div class="m-value" style="color: #27ae60;">{{ result.profit }} <span class="fs-4">₾</span></div>
                </div>
            </div>

            <h5 class="fw-bold mb-4 text-uppercase small" style="letter-spacing: 2px;">ხარჯების საოპერაციო ცხრილი</h5>
            <div class="table-responsive mb-5">
                <table class="imperial-table">
                    <thead>
                        <tr>
                            <th>კომპონენტი</th>
                            <th>ღირებულება</th>
                            <th>წილი ბიუჯეტში</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cost_name, cost_value in result.cost_details.items() %}
                        <tr>
                            <td>{{ cost_name }}</td>
                            <td class="fw-bold">{{ cost_value }} ₾</td>
                            <td width="30%">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="progress flex-grow-1" style="height: 6px; background: #eee;">
                                        <div class="progress-bar" style="width: {{ (cost_value / result.costs * 100) | round(1) }}%; background: var(--royal-gold);"></div>
                                    </div>
                                    <span class="small fw-bold">{{ (cost_value / result.costs * 100) | round(1) }}%</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-lg-6">
                    <div class="p-4 border rounded-4 bg-white text-center">
                        <canvas id="expensesChart" height="300"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 d-flex flex-column justify-content-center align-items-center">
                    <div class="text-center mb-4">
                        <div class="metric-label text-muted small mb-1">კილოგრამის საბაზრო ფასი</div>
                        <h3 class="fw-bold text-primary">{{ crops[request.form.get('crop')].market_price_per_kg }} ₾</h3>
                    </div>
                    <form action="{{ url_for('export_analysis_excel') }}" method="POST">
                        <input type="hidden" name="crop" value="{{ request.form.get('crop') }}">
                        <input type="hidden" name="area" value="{{ result.area }}">
                        <input type="hidden" name="yield" value="{{ result.yield }}">
                        <input type="hidden" name="income" value="{{ result.income }}">
                        <input type="hidden" name="costs" value="{{ result.costs }}">
                        <input type="hidden" name="profit" value="{{ result.profit }}">
                        <button type="submit" class="btn btn-outline-success rounded-pill px-5 fw-bold">
                            <i class="fas fa-file-excel me-2"></i> ჩამოტვირთე Excel რეპორტი
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <script>
            new Chart(document.getElementById('expensesChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: {{ result.cost_details.keys() | list | tojson }},
                    datasets: [{
                        data: {{ result.cost_details.values() | list | tojson }},
                        backgroundColor: ['#042f24', '#d4af37', '#1a7454', '#b8860b', '#2ecc71'],
                        borderWidth: 5,
                        borderColor: '#ffffff'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        </script>
        {% endif %}
    </div>
</div>

{% include 'footer.html' %}
</body>
</html>